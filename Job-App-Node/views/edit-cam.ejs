<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <style>
        fieldset {
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #f3f3f3;
        }

        .flex {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .radio {
            justify-content: center;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"] {
            height: 30px;

        }

        input[type="submit"] {
            padding: 10px;
            margin-top: 15px;
            background-color: black;
            color: white;
            cursor: pointer;
        }

        .accent {
            accent-color: green;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>

</head>

<body>
    <div>
    </div>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button"
                role="tab" aria-controls="home" aria-selected="true">Personal Info</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button"
                role="tab" aria-controls="profile" aria-selected="false">Educational Info</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button"
                role="tab" aria-controls="contact" aria-selected="false">Experience Info</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="language-tab" data-bs-toggle="tab" data-bs-target="#language" type="button"
                role="tab" aria-controls="language" aria-selected="false">Language Info</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tech-tab" data-bs-toggle="tab" data-bs-target="#tech" type="button" role="tab"
                aria-controls="tech" aria-selected="false">Technology Info</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ref-tab" data-bs-toggle="tab" data-bs-target="#ref" type="button" role="tab"
                aria-controls="ref" aria-selected="false">Reference Info</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="preference-tab" data-bs-toggle="tab" data-bs-target="#preference" type="button"
                role="tab" aria-controls="preference" aria-selected="false">Preference Info</button>
        </li>
    </ul>
    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
            <form action="/edit-user" method="post">

                <fieldset>
                    <legend>Basic Details</legend>
                    <div id="name" class="flex">
                        <input type="hidden" name="id" value="1">
                        <input type="hidden" name="user_id" value="<%= user_data[0].id %>">
                        <label for="fname">First Name:</label>
                        <input type="text" name="fname" id="fname" value="<%= user_data[0].first_name %>" />

                        <label for="lname">Last Name: </label>
                        <input type="text" name="lname" id="lname" value="<%= user_data[0].last_name %>" />
                    </div>
                    <br>
                    <div id="desig" class="flex">
                        <label for="desig">Job Info: </label>
                        <input type="text" name="desig" id="desig" value="Software Development" />

                        <label for="email">Email: </label>
                        <input type="email" name="email" id="email" value="<%= user_data[0].email %>" />
                    </div>
                    <br>


                    <div id="address">
                        <label for="address1">Address : </label> <br><br>
                        <input type="text" style="width: 100%;" name="address1" id="address1"
                            value="<%= user_data[0].address %>" />

                    </div>

                    <br>
                    <div id="city" class="flex">
                        <label for="city">City Data :</label>
                        <select name="city" id="city_drop">
                            <option selected disabled>Select City</option>
                        </select>
                        <label for="ph" style="margin-left: 5rem;">Phone Number: </label>
                        <input type="number" name="ph" id="ph" value="<%= user_data[0].contact_no %>" />
                    </div>

                    <br><br>
                    <div id="drops" class="flex">
                        <div class="flex">
                            <label for="city">Relationship Status: </label>
                            <select>
                                <% for(let i=0; i < gender_data.length; i++) {%>
                                    <option value="<%= gender_data[i].value %>" <% if(gender_data[i].value=="Married" )
                                        { %> selected <% } %> >
                                            <%= gender_data[i].value %>
                                    </option>
                                    <% } %>
                            </select>
                        </div>

                        <div class="flex">
                            <label>State: </label>
                            <select id="state" name="state" onchange="dropChange(this)">
                                <option selected disabled>Select State</option>
                                <% for(let i=0; i < state_data.length; i++) {%>
                                    <option value="<%= state_data[i].id %>" <% if(state_data[i].id==user_data[0].state)
                                        { %> selected <% } %> >

                                            <%= state_data[i].name %>
                                    </option>
                                    <% } %>
                            </select>
                        </div>

                    </div>


                    <br><br>
                    <div id="gender" class="flex">
                        <div class="flex radio">
                            <label for="">Gender</label> &nbsp;
                            <input type="radio" name="gender" id="gender" value="M" <% if(user_data[0].gender=="M" ) {
                                %> checked <% } %> > Male &nbsp;
                                <input type="radio" name="gender" id="gender" value="F" <% if(user_data[0].gender=="F" )
                                    { %> checked <% } %> > Female &nbsp;
                                    <input type="radio" name="gender" id="gender" value="O" <%
                                        if(user_data[0].gender=="O" ) { %> checked <% } %> > Prefer not to say &nbsp;
                        </div>
                        <div id="pincode">
                            <label for="pincode">Enter Pincode: </label>
                            <input type="text" name="pincode" id="pincode" placeholder="Enter Pincode" value="388001" />
                        </div>
                        <div id="dob">
                            <label for="">Date of Birth</label>
                            <input type="date" name="date" id="" value="<%= user_data[0].dob %>">
                        </div>
                    </div>
                </fieldset>

                <input type="submit" value="Update Personal Data">
            </form>
        </div>
        <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
            <form action="/edit-user" method="post">
                <fieldset>
                    <legend>Education Details</legend>
                    <input type="hidden" name="id" value="2">
                    <input type="hidden" name="user_id" value="<%= user_data[0].id %>">
                    <div id="educational-details">
                        <% for(let i=0; i<user_edu_data.length; i++) { %>
                            <div>
                                Course:
                                <select name="education">
                                    <% for(let j=0; j < course_data.length; j++) {%>
                                        <%= course_data[j].value %>
                                            <%= user_edu_data[i].board %>
                                                <option value="<%= course_data[j].value %>" <%
                                                    if(course_data[j].value==user_edu_data[i].course) { %> selected <% }
                                                        %>><%= course_data[j].value %>
                                                </option>
                                                <% } %>
                                </select>
                                Board: <input type="text" name="board" id="board" value="<%= user_edu_data[i].board %>">
                                &nbsp;
                                Passing Year: <input type="text" name="year" id="year"
                                    value="<%= user_edu_data[i].passing_year %>"> &nbsp;
                                Percentage: <input type="text" name="percentage" id="percentage"
                                    value="<%= user_edu_data[i].percentage %>"> &nbsp;
                                <br><br>
                            </div>
                            <% } %>
                    </div>
                    <a id="add" style="padding: 10px; background-color: #444; color: #fff ;">Add Experience</a>
                    <input type="submit" value="Update Education Data">
                </fieldset>

            </form>
        </div>
        <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
            <form action="/edit-user" method="post">
                <fieldset>
                    <input type="hidden" name="id" value="6">
                    <input type="hidden" name="user_id" value="<%= user_data[0].id %>">
                    <legend>Experience Details</legend>
                    <div id="experience-container">

                    </div>
                    <a id="add_expr" style="padding: 10px; background-color: #444; color: #fff ;">Add Experience</a>
                    <input type="submit" value="Update Education Data">
                </fieldset>
            </form>
        </div>
        <div class="tab-pane fade" id="language" role="tabpanel" aria-labelledby="language-tab">
            <form action="/edit-user" method="post">
                <fieldset>
                    <legend>Language Details</legend>
                    <div id="experience-container">
                        <center>
                            <div id="lang-container">
                                <input type="hidden" name="id" value="3">
                                <input type="hidden" name="user_id" value="<%= user_data[0].id %>">
                                <% for(let i=0; i < users_lang_data.length; i++) { %>
                                    <div class="lang">

                                        <input type="checkbox" name="lang"
                                            id="<%= users_lang_data[i].language %>_parent"
                                            value="<%= users_lang_data[i].language %>" class="accent"
                                            onclick="selectAll(this)" checked>
                                        <%= users_lang_data[i].language %>
                                            <input type="checkbox" name="<%= users_lang_data[i].language %>r"
                                                id="<%= users_lang_data[i].language %>" value=10
                                                onclick="updateParent(this)" <% if(users_lang_data[i].rea=='10' ) { %>
                                            checked <% } %>> Read


                                                <input type="checkbox" name="<%= users_lang_data[i].language %>w"
                                                    id="<%= users_lang_data[i].language %>" value=10
                                                    onclick="updateParent(this)" <% if(users_lang_data[i].wr=='10' ) {
                                                    %> checked <% } %>> Write


                                                    <input type="checkbox" name="<%= users_lang_data[i].language %>s"
                                                        id="<%= users_lang_data[i].language %>" value=10
                                                        onclick="updateParent(this)" <%
                                                        if(users_lang_data[i].speak=='10' ) { %> checked <% } %>> Speak
                                                        <br><br>
                                    </div>

                                    <% } %>
                            </div>
                            <input type="submit" value="Update Language">
                        </center>
                    </div>

                </fieldset>
            </form>
        </div>
        <div class="tab-pane fade" id="tech" role="tabpanel" aria-labelledby="tech-tab">
            <form action="/edit-user" method="post">
                <fieldset>
                    <legend>Technology Data</legend>
                    <center>
                        <input type="hidden" name="id" value="4">
                        <input type="hidden" name="user_id" value="<%= user_data[0].id %>">

                        <div id="tech-container">
                            <% for(let i=0; i<user_tech_data.length; i++) { %>
                                <div>
                                    <input type="checkbox" name="tech" class="accent"
                                        value="<%= user_tech_data[i].technology %>" checked>
                                    <%= user_tech_data[i].technology %>
                                        <input type="radio" name="<%= user_tech_data[i].technology %>a" value="beginner"
                                            <% if(user_tech_data[i].profiency=="beginner" ) { %> checked <% } %>>
                                            Beginner
                                            <input type="radio" name="<%= user_tech_data[i].technology %>a"
                                                value="intermediate" <% if(user_tech_data[i].profiency=="intermediate" )
                                                { %> checked <% } %>> Intermediate
                                                <input type="radio" name="<%= user_tech_data[i].technology %>a"
                                                    value="expert" <% if(user_tech_data[i].profiency=="expert" ) { %>
                                                checked <% } %>> Expert
                                </div>
                                <br>
                                <% } %>
                        </div>
                    </center>
                    <input type="submit" value="Update Technologies">

                </fieldset>
            </form>

        </div>
        <div class="tab-pane fade" id="ref" role="tabpanel" aria-labelledby="ref-tab">
            <form action="/edit-user" method="POST">
                <fieldset>
                    <legend>Reference Details</legend>
                    <input type="hidden" name="id" value="5">
                    <input type="hidden" name="user_id" value="<%= user_data[0].id %>">
                    <center>
                        <div id="ref-container">
                            <% for(let i=0; i<user_ref_data.length; i++) {%>
                                <div>
                                    Name: <input type="text" name="ref_name" value="<%= user_ref_data[i].name%>">
                                    Contact No: <input type="text" name="ref_cno"
                                        value="<%= user_ref_data[i].contact_no%>">
                                    Relation: <input type="text" name="ref_relation"
                                        value="<%= user_ref_data[i].relation%>">
                                </div><br>
                                <% } %>

                        </div>
                    </center>
                    <input type="submit" value="Update Reference">
                </fieldset>
            </form>
        </div>
        <div class="tab-pane fade" id="preference" role="tabpanel" aria-labelledby="preference-tab">
            <form action="/edit-user" method="post">
                <input type="hidden" name="id" value="7">
                <input type="hidden" name="user_id" value="<%= user_data[0].id %>">
                <fieldset>
                    <legend>Preferences</legend>
                    <center>
                        <div id="pref-container" class="flex" style="justify-content: space-around;">
                            <div>

                                Preffered Location:
                                <% let count=locations?.length%>
                                    <%= count %>
                                        <select multiple name="locations" id="loc-drop">
                                            <% for(let i=0; i < location_data?.length; i++) {%>
                                                <%= locations[count] %>
                                                    <%= location_data[i].value %>
                                                        <option value="<%= location_data[i].value %>">
                                                            <%= location_data[i].value %>
                                                        </option>
                                                        <% count-- %>
                                                            <% } %>
                                        </select>
                            </div>
                            <br><br>
                            <div class="flex" style="flex-direction: column;">
                                Notice Period: &nbsp;<input type="text" name="period"
                                    value="<%= user_location_data[0].Notice_Period%>"><br><br>
                                Expected CTC: &nbsp;<input type="text" name="ectc"
                                    value="<%= user_location_data[0].Expected_CTC %>"><br><br>
                                Current CTC: &nbsp;<input type="text" name="cctc"
                                    value="<%= user_location_data[0].Current_CTC %>"><br><br>
                            </div>
                            <div class="dep">
                                Department:
                                <select name="department">
                                    <option value="Development" selected>Development</option>
                                    <option value="Design">Design</option>
                                    <option value="Marketing">Marketing</option>
                                </select>
                            </div>

                        </div><br>

                        <input type="submit" value="Update Preferences">
        </div>
        </center>
        </fieldset>
        </form>
    </div>
    </div>


</body>

</html>
<script>
    let container = document.getElementById("educational-details");
    let state_id = document.getElementById("state").value;
    let city = document.getElementById("city_drop");

    let location_ans = '<%= locations %>';
    location_ans = location_ans.split(",")

    let loc_drop = document.getElementById("loc-drop");
    loc_drop.querySelectorAll('option').forEach(option => {
        if (location_ans.includes(option.value)) {
            // Set the selected attribute to true
            option.selected = true;
        }
    })

    fetch(`/state/${state_id}`)
        .then(resp => resp.json())
        .then(data => {
            console.log(data)
            city.innerHTML = ""
            let user_selected_city = `<%= user_data[0].city %>`;
            data.ans.forEach(d => {
                // city.innerHTML += `<option value=${d.name_city}  }>${d.name_city}</option>`
                const option = document.createElement('option');
                option.value = d.name_city;
                option.textContent = d.name_city;
                if (d.name_city === user_selected_city) {
                    option.selected = true;
                }
                city.appendChild(option)
            })
        }
        );

    let edu_string = ``;
    const urlPath = window.location.pathname;
    const segments = urlPath.split("/");
    const id = segments[segments.length - 1];

    fetch(`/experience-data/${id}`)
        .then(res => res.json())
        .then(data => {
            let experience_details = ``;
            data["ans"].forEach(ele => {
                experience_details += `
                <div>
                    Company Name: <input type="text" name="company" id="company" value="${ele.company_name}"> &nbsp;
                    CTC: <input type="text" name="designation" id="designation" value="${ele.CTC}"> &nbsp;
                    From: <input type="date" name="from_date" id="from_date" value="${ele.start_date}"> &nbsp;
                    To: <input type="date" name="to_date" id="to_date" value="${ele.end_date}"> &nbsp;
                    <br><br>
                </div>
                `
            })
            document.getElementById("experience-container").innerHTML = experience_details
        })




    function dropChange(element) {
        let city = document.getElementById("city_drop");
        var state_id = element.value;
        fetch(`/state/${state_id}`)
            .then(resp => resp.json())
            .then(data => {
                console.log(data)
                city.innerHTML = ""
                data.ans.forEach(d => {
                    city.innerHTML += `<option value=${d.name_city}>${d.name_city}</option>`
                })
            }

            );
    }
    var lang_data = '<%= JSON.stringify(lang_data) %>';
    var decode_lang = lang_data.replace(/&#34;/g, '"');
    var languageOptions = JSON.parse(decode_lang);


    var user_lang_data = '<%= JSON.stringify(users_lang_data) %>';
    var user_decode_lang = user_lang_data.replace(/&#34;/g, '"');
    var languageProficiencies = JSON.parse(user_decode_lang);


    var tech_data = '<%= JSON.stringify(tech_data) %>';
    var decode_tech = tech_data.replace(/&#34;/g, '"');
    var technologyOptions = JSON.parse(decode_tech);

    var user_tech_data = '<%= JSON.stringify(user_tech_data) %>';
    var user_decode_tech = user_tech_data.replace(/&#34;/g, '"');
    var techProficiencies = JSON.parse(user_decode_tech);

    const newTechProficiencies = [];

    for (const techOption of technologyOptions) {
        const matchingProficiency = techProficiencies.find(
            proficiency => proficiency.technology === techOption.value
        );
        if (!matchingProficiency) {
            newTechProficiencies.push({
                language: techOption.value,
            });
        }
    }
    console.log(newTechProficiencies);

    const newLanguageProficiencies = [];

    for (const languageOption of languageOptions) {
        const matchingProficiency = languageProficiencies.find(
            proficiency => proficiency.language === languageOption.value
        );
        if (!matchingProficiency) {
            newLanguageProficiencies.push({
                language: languageOption.value,
            });
        }
    }
    console.log(newLanguageProficiencies);
    let new_ops = ``;
    newLanguageProficiencies.forEach(newLang => {
        new_ops += `<input type="checkbox" name="lang" class="accent" id="${newLang.language}" value="${newLang.language}" /> ${newLang.language}
                <input type="checkbox" name="${newLang.language}r" id="${newLang.language}" value='10'> Read 
                <input type="checkbox" name="${newLang.language}w" id="${newLang.language}" value=10> Write 
                <input type="checkbox" name="${newLang.language}s" id="${newLang.language}" value=10 <> Speak <br/><br/>`

    })
    document.getElementById("lang-container").innerHTML += new_ops;
    let new_tech = "";
    newTechProficiencies.forEach(newTech => {
        new_tech += `<div>
                    <input type="checkbox" name="tech" class="accent" value="${newTech.language}"> ${newTech.language} 
                    <input type="radio" name="${newTech.language}a" value="beginner" > Beginner
                    <input type="radio" name="${newTech.language}a" value="intermediate"> Intermediate
                    <input type="radio" name="${newTech.language}a" value="expert"> Expert
                    </div>
                    <br>
        `
    })
    document.getElementById("tech-container").innerHTML += new_tech;

    var data = '<%= JSON.stringify(course_data) %>';
    var decodedData = data.replace(/&#34;/g, '"');
    var parsedData = JSON.parse(decodedData);
    document.getElementById("add").addEventListener("click", () => {
        const newDivForEd = document.createElement("div");
        newDivForEd.innerHTML += `Course: `
        const newSelect = document.createElement("select");
        newSelect.name = "education"
        for (let i = 0; i < parsedData.length; i++) {
            const newOption = document.createElement('option')
            newOption.text = parsedData[i].value;
            newOption.value = parsedData[i].value;
            newSelect.appendChild(newOption);
        }

        newDivForEd.appendChild(newSelect);
        newDivForEd.innerHTML += `
        Board: <input type="text" name="board" id="board"> &nbsp;
        Passing Year: <input type="text" name="year" id="year"> &nbsp;
        Percentage: <input type="text" name="percentage" id="percentage"> <br> &nbsp;
        `;
        container.appendChild(newDivForEd);
    });
    let expr_container = document.getElementById("experience-container")

    document.getElementById("add_expr").addEventListener("click", () => {

        const newDivForEx = document.createElement("div");
        newDivForEx.innerHTML = `
                        Company Name: <input type="text" name="company" id="company"> &nbsp;
                        CTC: <input type="text" name="designation" id="designation"> &nbsp;
                        From: <input type="date" name="from_date" id="from_date"> &nbsp;
                        To: <input type="date" name="to_date" id="to_date"> &nbsp;
                        <br><br>
                    `
        expr_container.appendChild(newDivForEx);
    })

</script>